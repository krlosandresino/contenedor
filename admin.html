<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ†Ô∏è Panel Administrador</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #0f172a; color: #f8fafc; padding: 20px; }
        .admin-container { max-width: 1200px; margin: 0 auto; }
        .header-admin { display: flex; justify-content: space-between; align-items: center; background: #1e293b; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #334155; }
        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { background: #1e293b; padding: 15px; border-radius: 10px; border-bottom: 4px solid #3b82f6; }
        .card h3 { margin: 0; font-size: 0.85em; color: #94a3b8; text-transform: uppercase; }
        .card p { margin: 10px 0 0; font-size: 1.8em; font-weight: bold; }
        .stats-container { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 25px; }
        .chart-card { background: #1e293b; padding: 20px; border-radius: 12px; border: 1px solid #334155; min-height: 300px; }
        .ranking-list { background: #1e293b; padding: 20px; border-radius: 12px; border: 1px solid #334155; }
        .ranking-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #334155; font-size: 0.9em; }
        .admin-actions { background: #1e293b; padding: 15px; border-radius: 12px; margin-bottom: 25px; display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; border: none; }
        .btn-upload { background: #3b82f6; color: white; }
        .btn-clear { background: #ef4444; color: white; }
        .btn-report { background: #10b981; color: white; }
        .monitor-section { background: #1e293b; border-radius: 12px; padding: 15px; border: 1px solid #334155; }
        .table-wrapper { overflow-x: auto; max-height: 500px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #334155; color: #3b82f6; text-align: left; padding: 12px; position: sticky; top: 0; }
        td { padding: 12px; border-bottom: 1px solid #334155; font-size: 0.9em; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75em; font-weight: bold; }
        .badge-visto { background: #065f46; color: #34d399; }
        .badge-pendiente { background: #7c2d12; color: #fb923c; }
        .badge-error { background: #7f1d1d; color: #f87171; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: #1e293b; padding: 30px; border-radius: 12px; width: 350px; text-align: center; border: 1px solid #334155; }
        input[type="text"], input[type="password"] { width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; }
    </style>
</head>
<body>

<div id="modalAdmin" class="modal-overlay">
    <div class="modal-content">
        <h3>üîê Acceso Admin</h3>
        <input type="text" id="adminUser" placeholder="Usuario" autocomplete="off">
        <input type="password" id="adminPass" placeholder="Contrase√±a" autocomplete="off">
        <button class="btn btn-upload" style="width:100%; margin-top:10px;" onclick="verificarAdmin()">Entrar al Panel</button>
    </div>
</div>

<div class="admin-container">
    <div class="header-admin">
        <h2>üõ†Ô∏è Panel de Gesti√≥n administrador</h2>
        <span id="currentTime" style="color:#94a3b8"></span>
    </div>

    <div class="grid-stats">
        <div class="card"><h3>Progreso</h3><p id="statProgreso">0%</p></div>
        <div class="card"><h3>Total Pallets</h3><p id="statTotalPallets">0</p></div>
        <div class="card"><h3>Faltan Buscar</h3><p id="statPendientesPallets" style="color:#fb923c">0</p></div>
        
        <div class="card"><h3>Vistos (items)</h3><p id="statVistos">0</p></div>
        <div class="card"><h3>Incidencias</h3><p id="statIncidencias" style="color:#f87171">0</p></div>
        <div class="card"><h3>Usuarios</h3><p id="statUsuarios">0</p></div>
    </div>

    <div class="stats-container">
        <div class="chart-card">
            <h3 style="font-size: 0.85em; color: #94a3b8; margin-bottom: 15px;">üìä ITEMS POR USUARIO</h3>
            <div style="height: 250px;"><canvas id="prodChart"></canvas></div>
        </div>
        <div class="ranking-list">
            <h3 style="font-size: 0.9em; color: #94a3b8; margin-top: 0;">‚ö° RANKING DE RENDIMIENTO</h3>
            <div id="rankingVelocidad"><p style="color:#64748b; font-size: 0.8em;">Esperando datos...</p></div>
        </div>
    </div>

    <div class="admin-actions">
        <input type="file" id="fileInput" accept=".xlsx, .xls" style="display:none">
        <button class="btn btn-upload" onclick="document.getElementById('fileInput').click()">üìÇ Cargar archivo Excel</button>
        <button class="btn btn-report" onclick="exportarReporte()">üì• Descargar Reporte</button>
        <button class="btn btn-clear" onclick="limpiarBase()">üóëÔ∏è Limpiar datos</button>
    </div>

    <div class="monitor-section">
        <h3>Monitoreo en Tiempo Real</h3>
        <div class="table-wrapper">
            <table>
                <thead id="adminHeaders">
                    <tr>
                        <th>Pallet</th>
                        <th>C√≥digo</th>
                        <th>Estado</th>
                        <th>Responsable</th>
                        <th>Hora</th>
                        <th>Incidencias</th>
                    </tr>
                </thead>
                <tbody id="adminTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBj-XjFkKnbl-f5IVCXymfaPACK2ZwPrXo",
        authDomain: "pcontenedor-83239.firebaseapp.com",
        databaseURL: "https://pcontenedor-83239-default-rtdb.firebaseio.com",
        projectId: "pcontenedor-83239",
        storageBucket: "pcontenedor-83239.firebasestorage.app",
        messagingSenderId: "517861302737",
        appId: "1:517861302737:web:2c6e7b97062dbf7e6900f0"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let dbGlobal = [];
    let headersGlobal = [];
    let miGrafico = null;

    function verificarAdmin() {
        const u = document.getElementById('adminUser').value;
        const p = document.getElementById('adminPass').value;
        if (u === "oriflame" && p === "2026") {
            document.getElementById('modalAdmin').style.display = 'none';
        } else { alert("Acceso denegado"); }
    }

    [document.getElementById('adminUser'), document.getElementById('adminPass')].forEach(input => {
        input.addEventListener('keydown', (e) => { if (e.key === 'Enter') verificarAdmin(); });
    });

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = (event) => {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const raw = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
            if (raw.length > 0) {
                const items = raw.slice(1).filter(f => f.length > 0).map((f, i) => ({
                    datos: f, visto: false, auditor: "", fechaHora: "", rowId: i, incidencia: "", auditorIncidencia: ""
                }));
                database.ref('carga').set({ headers: raw[0].slice(0, 6), items: items })
                .then(() => alert("Base de datos actualizada con √©xito"));
            }
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    });

    function limpiarBase() {
        if(confirm("¬øEst√°s seguro de borrar TODA la informaci√≥n?")) { database.ref('carga').remove(); }
    }

    database.ref('carga').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data && data.items) {
            dbGlobal = data.items;
            headersGlobal = data.headers;
            actualizarInterfaz(data.items);
            procesarProductividad(data.items);
        } else {
            document.getElementById('adminTableBody').innerHTML = "";
            actualizarInterfaz([]);
            procesarProductividad([]);
        }
    });

    function actualizarInterfaz(items) {
        const tbody = document.getElementById('adminTableBody');
        tbody.innerHTML = '';
        let vistosItems = 0, incidencias = 0, usuarios = new Set();

        const idsUnicos = [...new Set(items.map(f => String(f.datos[0]).trim()))];
        const palletsPendientes = idsUnicos.filter(id => 
            items.filter(f => String(f.datos[0]).trim() === id).some(f => !f.visto)
        ).length;

        const itemsOrdenados = [...items].sort((a, b) => (a.visto === b.visto) ? 0 : a.visto ? 1 : -1);

        itemsOrdenados.forEach(item => {
            if (item.visto) { vistosItems++; usuarios.add(item.auditor); }
            if (item.incidencia) { incidencias++; usuarios.add(item.auditorIncidencia); }

            const tr = document.createElement('tr');
            const d = item.datos;
            // Solo para mostrar Pallet y C√≥digo en la tabla de monitoreo
            tr.innerHTML = `
                <td><b>${d[0]}</b></td>
                <td>${d[1] || '-'}</td>
                <td><span class="badge ${item.visto ? 'badge-visto' : 'badge-pendiente'}">${item.visto ? 'VISTO' : 'PENDIENTE'}</span></td>
                <td>${item.auditor || '-'}</td>
                <td><small>${item.fechaHora || '-'}</small></td>
                <td>${item.incidencia ? `<span class="badge badge-error">${item.incidencia}</span>` : '-'}</td>
            `;
            tbody.appendChild(tr);
        });

        const totalItems = items.length;
        document.getElementById('statProgreso').innerText = totalItems > 0 ? Math.round((vistosItems/totalItems)*100)+'%' : '0%';
        document.getElementById('statTotalPallets').innerText = idsUnicos.length;
        document.getElementById('statPendientesPallets').innerText = palletsPendientes;
        document.getElementById('statVistos').innerText = vistosItems;
        document.getElementById('statIncidencias').innerText = incidencias;
        document.getElementById('statUsuarios').innerText = usuarios.size;
    }

    function procesarProductividad(items) {
        const conteoVistos = {};
        items.forEach(item => {
            if (item.visto && item.auditor) {
                conteoVistos[item.auditor] = (conteoVistos[item.auditor] || 0) + 1;
            }
        });
        actualizarGrafico(conteoVistos);
        actualizarRanking(conteoVistos);
    }

    function actualizarGrafico(datos) {
        const ctx = document.getElementById('prodChart').getContext('2d');
        const labels = Object.keys(datos);
        const valores = Object.values(datos);
        if (miGrafico) miGrafico.destroy();
        miGrafico = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Revisados',
                    data: valores,
                    backgroundColor: '#3b82f6',
                    borderColor: '#60a5fa',
                    borderWidth: 1,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8', stepSize: 1 } },
                    x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                }
            }
        });
    }

    function actualizarRanking(conteo) {
        const contenedor = document.getElementById('rankingVelocidad');
        contenedor.innerHTML = '';
        const ranking = Object.entries(conteo).sort((a, b) => b[1] - a[1]);
        if (ranking.length === 0) {
            contenedor.innerHTML = '<p style="color:#64748b; font-size: 0.8em;">Sin actividad registrada</p>';
            return;
        }
        ranking.forEach(([nombre, total], index) => {
            const div = document.createElement('div');
            div.className = 'ranking-item';
            div.innerHTML = `<span>${index + 1}. üë§ ${nombre}</span><span style="color:#10b981"><b>${total}</b> items</span>`;
            contenedor.appendChild(div);
        });
    }

    function exportarReporte() {
        if (dbGlobal.length === 0) return alert("No hay datos");
        const excelData = dbGlobal.map(f => {
            let item = {};
            // REORDENAMIENTO EXCEL: 0, 1, 2 (Boxes), 4 (Units per box), 3 (Units), 5
            const indicesOrdenados = [0, 1, 2, 4, 3, 5];
            
            indicesOrdenados.forEach((idx) => {
                const h = headersGlobal[idx] || `Columna_${idx}`;
                item[h] = f.datos[idx];
            });
            
            item["ESTADO"] = f.visto ? "VISTO" : "PENDIENTE";
            item["RESPONSABLE"] = f.auditor;
            item["FECHA"] = f.fechaHora;
            item["INCIDENCIA"] = f.incidencia || "";
            return item;
        });
        const ws = XLSX.utils.json_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Reporte");
        XLSX.writeFile(wb, "Reporte_Admin.xlsx");
    }

    setInterval(() => { document.getElementById('currentTime').innerText = new Date().toLocaleString(); }, 1000);
</script>
</body>
</html>