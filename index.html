<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revisi贸n de carga Cloud</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 95%; max-width: 1100px; }
        .dashboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #fff; border: 1px solid #e1e4e8; padding: 15px; border-radius: 10px; text-align: center; }
        .stat-number { display: block; font-size: 24px; font-weight: bold; color: #2c3e50; }
        .stat-label { font-size: 12px; color: #7f8c8d; text-transform: uppercase; }
        .upload-section { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px dashed #3498db; margin-bottom: 20px; text-align: center; }
        .btn-download { background-color: #27ae60; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        input[type="text"] { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #bdc3c7; border-radius: 6px; font-size: 18px; box-sizing: border-box; }
        #nombreResponsable { text-transform: uppercase; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 400px; text-align: center; }
        .btn-confirm { background: #3498db; color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 15px; }
        .table-container { width: 100%; overflow-x: auto; margin-top: 10px; max-height: 500px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { background-color: #3498db; color: white; position: sticky; top: 0; }
        tr.checked { background-color: #e8f5e9 !important; color: #2e7d32; }
        tr.checked td { text-decoration: line-through; opacity: 0.6; }
        .btn-check { background-color: #2ecc71; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        .btn-check.undo { background-color: #e74c3c; }
    </style>
</head>
<body>

<div id="modalPersona" class="modal-overlay">
    <div class="modal-content">
        <h3> Identificaci贸n</h3>
        <p>Responsable para el <b>Pallet <span id="modalPalletId"></span></b>:</p>
        <input type="text" id="nombreResponsable" placeholder="Escriba su nombre y pulse Enter...">
        <button class="btn-confirm" onclick="confirmarResponsable()">Continuar</button>
    </div>
</div>

<div class="container">
    <h2>Contenedor de carga (Sincronizado)</h2>
    <div class="dashboard" id="dashboard">
        <div class="stat-card"><span class="stat-number" id="totalPallets">0</span><span class="stat-label">Total Pallets</span></div>
        <div class="stat-card"><span class="stat-number" id="pendingPallets" style="color: #e67e22;">0</span><span class="stat-label">Faltan Buscar</span></div>
        <div class="stat-card"><span class="stat-number" id="totalItems">0</span><span class="stat-label">Vistos Global</span></div>
    </div>
    
    <div class="upload-section">
        <p>Subir archivo maestro (Solo Administrador):</p>
        <input type="file" id="fileInput" accept=".xlsx, .xls">
        <button id="downloadBtn" class="btn-download" onclick="exportarReporte()"> Descargar Reporte Final</button>
    </div>

    <input type="text" id="palletInput" placeholder="Escanee n煤mero de Pallet...">

    <div id="resultsArea" style="display: none;">
        <h3 id="currentPalletTitle"></h3>
        <div class="table-container">
            <table>
                <thead><tr id="tableHeaders"></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURACIN DE FIREBASE ACTUALIZADA ---
    const firebaseConfig = {
        apiKey: "AIzaSyBj-XjFkKnbl-f5IVCXymfaPACK2ZwPrXo",
        authDomain: "pcontenedor-83239.firebaseapp.com",
        databaseURL: "https://pcontenedor-83239-default-rtdb.firebaseio.com",
        projectId: "pcontenedor-83239",
        storageBucket: "pcontenedor-83239.firebasestorage.app",
        messagingSenderId: "517861302737",
        appId: "1:517861302737:web:2c6e7b97062dbf7e6900f0"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let dbGlobal = [];
    let headers = [];
    let palletTemporal = "";
    let auditorActual = "";

    // Sincronizaci贸n en tiempo real con la nube
    database.ref('carga').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            dbGlobal = data.items || [];
            headers = data.headers || [];
            actualizarContadores();
            prepararCabeceras();
            if (palletTemporal) renderizarPallet(palletTemporal, auditorActual);
        }
    });

    // Carga inicial (Solo el administrador debe hacer esto)
    document.getElementById('fileInput').addEventListener('change', function(e) {
        if (!confirm("驴Deseas subir este nuevo archivo? Se borrar谩n los datos anteriores en la nube.")) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const raw = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
            if (raw.length > 0) {
                const initialHeaders = raw[0].slice(0, 6);
                const initialItems = raw.slice(1).map((fila, index) => ({
                    datos: fila, visto: false, auditor: "", fechaHora: "", rowId: index
                }));
                database.ref('carga').set({
                    headers: initialHeaders,
                    items: initialItems
                });
                alert("Base de datos actualizada con 茅xito.");
            }
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    });

    function prepararCabeceras() {
        if(headers.length > 0) {
            document.getElementById('tableHeaders').innerHTML = headers.map(h => `<th>${h || ''}</th>`).join('') + '<th>Estado</th>';
        }
    }

    document.getElementById('nombreResponsable').addEventListener('keydown', e => { if (e.key === 'Enter') confirmarResponsable(); });

    document.getElementById('palletInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            const id = this.value.trim();
            const existe = dbGlobal.some(f => String(f.datos[0]).trim() === id);
            
            if (existe) {
                palletTemporal = id;
                document.getElementById('modalPalletId').innerText = id;
                document.getElementById('modalPersona').style.display = 'flex';
                document.getElementById('nombreResponsable').value = "";
                setTimeout(() => document.getElementById('nombreResponsable').focus(), 150);
            } else { 
                alert("Pallet " + id + " no encontrado en la base de datos."); 
            }
            this.value = '';
        }
    });

    function confirmarResponsable() {
        const nombre = document.getElementById('nombreResponsable').value.trim().toUpperCase();
        if (!nombre) return alert("Ingrese un nombre");
        auditorActual = nombre;
        document.getElementById('modalPersona').style.display = 'none';
        renderizarPallet(palletTemporal, auditorActual);
    }

    function renderizarPallet(id, auditor) {
        const area = document.getElementById('resultsArea');
        const body = document.getElementById('tableBody');
        const coincidencias = dbGlobal.filter(f => String(f.datos[0]).trim() === id);
        
        area.style.display = 'block';
        document.getElementById('currentPalletTitle').innerText = `Pallet: ${id} | USUARIO: ${auditor}`;
        body.innerHTML = '';

        coincidencias.forEach(filaObj => {
            const tr = document.createElement('tr');
            if (filaObj.visto) tr.className = 'checked';
            
            for (let i = 0; i < 6; i++) {
                const td = document.createElement('td');
                td.innerText = filaObj.datos[i] || '-';
                tr.appendChild(td);
            }

            const tdAccion = document.createElement('td');
            const btn = document.createElement('button');
            btn.className = filaObj.visto ? 'btn-check undo' : 'btn-check';
            btn.innerText = filaObj.visto ? `Visto por ${filaObj.auditor}` : 'Marcar Visto';
            
            btn.onclick = () => {
                // Validaci贸n de seguridad: Solo el que marc贸 puede desmarcar
                if (filaObj.visto && filaObj.auditor !== auditor) {
                    alert("Solo " + filaObj.auditor + " puede revertir este item.");
                    return;
                }
                const newVisto = !filaObj.visto;
                database.ref(`carga/items/${filaObj.rowId}`).update({
                    visto: newVisto,
                    auditor: newVisto ? auditor : "",
                    fechaHora: newVisto ? new Date().toLocaleString() : ""
                });
            };
            
            tdAccion.appendChild(btn);
            tr.appendChild(tdAccion);
            body.appendChild(tr);
        });
    }

    function actualizarContadores() {
        const ids = [...new Set(dbGlobal.map(f => String(f.datos[0]).trim()))];
        let pen = 0;
        ids.forEach(id => {
            if (dbGlobal.filter(f => String(f.datos[0]).trim() === id).some(f => !f.visto)) pen++;
        });
        document.getElementById('totalPallets').innerText = ids.length;
        document.getElementById('pendingPallets').innerText = pen;
        document.getElementById('totalItems').innerText = dbGlobal.filter(f => f.visto).length;
    }

    function exportarReporte() {
        if (dbGlobal.length === 0) return alert("No hay datos cargados.");
        
        const datosExportar = dbGlobal.map(f => {
            let item = {};
            headers.forEach((h, i) => item[h || `Dato${i+1}`] = f.datos[i]);
            item["ESTADO"] = f.visto ? "VISTO" : "PENDIENTE";
            item["RESPONSABLE"] = f.auditor || "";
            item["FECHA_HORA"] = f.fechaHora || "";
            return item;
        });

        const ws = XLSX.utils.json_to_sheet(datosExportar);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Auditoria_Final");
        XLSX.writeFile(wb, "Reporte_Contenedor_Global.xlsx");
    }
</script>
</body>
</html>